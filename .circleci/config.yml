version: 2.1
workflows:
  version: 2.1
  build_and_test: #workflow名
    jobs:
      - build
      - test:
          requires:
            - build  
      - formatCheck:
          requires:
            - build  
      - stepCountDiff:
          requires:
            - build  
      - stepCountAll:
          requires:
            - build 
          filters:
            branches:
              only: master 
      - releaseStaging:
          requires:
            - test
            - formatCheck
jobs:
  build:
    docker:
      - image: circleci/node:8.11.3
    working_directory: ~/workspace
    steps:
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
            - source-v1-{{ .Branch }}-
            - source-v1-
      - checkout
      - save_cache:
          key: source-v1-{{ .Branch }}-{{ .Revision }}
          paths:
            - .git
      - restore_cache:
          key: v1-npm-deps-{{ checksum "yarn.lock" }}
      - run: yarn
      - save_cache:
          key: v1-npm-deps-{{ checksum "yarn.lock" }}
          paths:
            - node_modules
      - persist_to_workspace:
          root: . # workspaceのrootパス（絶対パスかworking_directoryからの相対パス）
          paths:
            - . # 共有するパス（絶対パスかrootからの相対パス）
  test:
    docker: # See https://docs.docker.com/get-started/#docker-concepts if you are new to Docker.
      - image: circleci/openjdk:8u181-jdk-node-browsers-legacy
    working_directory: ~/workspace
    steps:
      - attach_workspace: # workspaceをアタッチする
          at: .
      - run: sudo chmod +x ./gradlew
      - run: ./gradlew test
  formatCheck:
    docker:
      - image: circleci/node:8.11.3
    working_directory: ~/workspace
    steps:
      - attach_workspace: # workspaceをアタッチする
          at: .
      - run: sudo chmod +x node_modules/.bin/eslint
      - run:
          name: lint
          command: |
            mkdir -p /tmp/test-reports/eslint
            node_modules/.bin/eslint . --format junit --output-file /tmp/test-reports/eslint/results.xml
      - store_test_results:
          path: /tmp/test-reports
      - store_artifacts:
          path: /tmp/test-reports
  stepCountDiff:
    docker:
      - image: circleci/node:8.11.3
    working_directory: ~/workspace
    environment:
      - BASH_ENV: envrc
    steps:
      - attach_workspace: # workspaceをアタッチする
          at: .
      - run: sudo chmod +x ./step.sh
      - run: sh step.sh
  stepCountAll:
    docker:
      - image: circleci/node:8.11.3
    working_directory: ~/workspace
    steps:
      - attach_workspace: # workspaceをアタッチする
          at: .
      - run: sudo chmod +x node_modules/.bin/cloc
      - run:
          name: cloc
          command: |
            # 差分
            ./node_modules/.bin/cloc src
  releaseStaging:
    docker: # See https://docs.docker.com/get-started/#docker-concepts if you are new to Docker.
      - image: circleci/openjdk:8u181-jdk-node-browsers-legacy
    working_directory: ~/workspace
    steps:
      - attach_workspace: # workspaceをアタッチする
          at: .
      - run: mkdir /tmp/jarFile;
      - run: sudo chmod +x ./gradlew
      - run: ./gradlew build 
      - run: cp ./build/libs/circleCITest-0.0.1-SNAPSHOT.jar /tmp/jarFile/circleCItest.jar;

      - store_artifacts:
          path: /tmp/jarFile/circleCITest.jar;
          destination: artifact-file

      - store_artifacts:
          path: /tmp/jarFile